<!DOCTYPE html>
<html>
  <head>
    <style>

      #mount {
        width: 400px;
        height: 300px;
      }

      .stage {
        width: 100%;
        background-color: #f0f0f0;
      }
    </style>
    <script src="lib.js"></script>
  </head>
  <body>
    <div id="mount"></div>

    <script data-id="2d-vertex" type="x-shader/x-vertex">
    
      uniform vec2 u_origin;
      uniform vec2 u_resolution;

      attribute vec2 a_position;
      attribute vec2 a_texCoord;

      varying vec2 v_texCoord;

      void main() {

        vec2 p = a_position + u_origin;

        vec2 clipSpace = (p / u_resolution * 2.0 - 1.0) * vec2(1, -1);

        gl_Position = vec4(clipSpace, 0, 1);

        // Pass the texCoord to the fragment shader
        // The GPU will interpolate this value between points.
        v_texCoord = a_texCoord;
      }

    </script>
     
    <script data-id="2d-fragment" type="x-shader/x-fragment">

      precision mediump float;

      // our texture
      uniform sampler2D u_image;

      // the texCoords passed in from the vertex shader.
      varying vec2 v_texCoord;

      void main() {
         gl_FragColor = texture2D(u_image, v_texCoord).rgba;
      }

    </script>

    <script>

      'use strict';

      var CANVAS_WIDTH = 800;
      var CANVAS_HEIGHT = 600;
      var VIEWPORT_WIDTH = 800;
      var VIEWPORT_HEIGHT = 600;

      function Tile() {
        this.x = 0;
        this.y = 0;
        this.width = 16;
        this.height = 16;
        this.index = 0;

        // Quad
        this.verts = new Float32Array([
        // x   y  u  v
          -1, -1, 0, 1,
           1, -1, 1, 1,
           1,  1, 1, 0,

          -1, -1, 0, 1,
           1,  1, 1, 0,
          -1,  1, 0, 0
        ]);
      }

      // var tile = {
      //   x: 0,
      //   y: 0,
      //   width: 16,
      //   height: 16,
      //   index: 10
      // };

      // var a = Object.create(tile);
      // a.x = 100;
      // console.dir(tile);
      // console.dir(a);

      function createShaders(gl, vertexId, fragmentId) {

        var vertexShaderSource = getVertexShaderFromTemplate(vertexId);
        var fragmentShaderSource = getFragmentShaderFromTemplate(fragmentId);

        var vertexShader = gl.createShader(gl.VERTEX_SHADER);
        var fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
        gl.shaderSource(vertexShader, vertexShaderSource);
        gl.shaderSource(fragmentShader, fragmentShaderSource);
        gl.compileShader(vertexShader);
        gl.compileShader(fragmentShader);

        return {
          vertex: vertexShader,
          fragment: fragmentShader
        };
      }

      function createProgram(gl, shaders) {

        var program = gl.createProgram();
        gl.attachShader(program, shaders.vertex);
        gl.attachShader(program, shaders.fragment);

        gl.linkProgram(program);
        gl.useProgram(program);

        return program;
      }

      function setViewport(gl, x, y, width, height) {
        gl.viewport(x, y, width, height);
      }

      function setRectangle(gl, x, y, width, height) {
        var x1 = x;
        var x2 = x + width;
        var y1 = y;
        var y2 = y + height;
        gl.bufferData(
          gl.ARRAY_BUFFER,
          new Float32Array([
            x1, y1,
            x2, y1,
            x1, y2,
            x1, y2,
            x2, y1,
            x2, y2]),
          gl.STATIC_DRAW
        );
      }

      function go(canvas, gl, image) {

        // Look up where the vertex data needs to go.
        var positionLocation = gl.getAttribLocation(program, 'a_position');
        var texCoordLocation = gl.getAttribLocation(program, 'a_texCoord');

        // Provide texture coordinates for the rectangle.
        var texCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, texCoordBuffer);
        gl.bufferData(
          gl.ARRAY_BUFFER,
          new Float32Array(
            [
              0.0,  0.0,
              1.0,  0.0,
              0.0,  1.0,
              0.0,  1.0,
              1.0,  0.0,
              1.0,  1.0
            ]
          ),
          gl.STATIC_DRAW
        );
        gl.enableVertexAttribArray(texCoordLocation);
        gl.vertexAttribPointer(texCoordLocation, 2, gl.FLOAT, false, 0, 0);

        // Create a texture.
        var texture = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, texture);

        // Set the parameters so we can render any size image.
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);

        // Upload the image into the texture.
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);

        // Lookup uniforms
        var resolutionLocation = gl.getUniformLocation(program, 'u_resolution');
        var originLocation = gl.getUniformLocation(program, 'u_origin');

        // Set the resolution
        gl.uniform2f(resolutionLocation, canvas.width, canvas.height);

        // Create a buffer for the position of the rectangle corners.
        var buffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
        gl.enableVertexAttribArray(positionLocation);
        gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);

        // Set a rectangle the same size as the image.
        setRectangle(gl, 0, 0, image.width, image.height);

        var i = 0;

        function draw() {
          i += 0.1;
          gl.uniform2f(originLocation, i, i);
          gl.drawArrays(gl.TRIANGLES, 0, 6);
          // window.requestAnimationFrame(loop);
        }

        draw();

        window.gl = gl;
      }

      var canvas = createCanvas(CANVAS_WIDTH, CANVAS_HEIGHT, 'stage', '#mount');
      var gl = canvas.getContext('webgl');

      if (gl) {
        var shaders = createShaders(gl, '2d-vertex', '2d-fragment');
        var program = createProgram(gl, shaders);
        setViewport(gl, 0, 0, VIEWPORT_WIDTH, VIEWPORT_HEIGHT);

        loadImage('leds@2x.png', function (image) {
          go(canvas, gl, image);
        });

      } else {
        alert('Sorry, your browser does not support WebGL');
      }

    </script>
  </body>
</html>